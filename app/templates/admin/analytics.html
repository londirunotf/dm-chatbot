{% extends "admin/base.html" %}

{% block content %}
<div class="analytics-dashboard">
    <div class="dashboard-header">
        <div class="header-content">
            <h2>ğŸ“ˆ åˆ†æãƒ»çµ±è¨ˆ</h2>
            <div class="dashboard-time">
                <span id="lastUpdated">æœ€çµ‚æ›´æ–°: èª­ã¿è¾¼ã¿ä¸­...</span>
                <button type="button" id="refreshAnalytics" class="btn-refresh" title="ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                </button>
                <button type="button" id="exportData" class="btn btn-secondary" title="ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293V6.5z"/>
                        <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                    </svg>
                    CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
            </div>
        </div>
    </div>

    <!-- çµ±è¨ˆæ¦‚è¦ã‚«ãƒ¼ãƒ‰ -->
    <div class="analytics-stats">
        <div class="stat-card">
            <div class="stat-icon">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                    <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
                    <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ user_stats.total_users or 0 }}</div>
                <div class="stat-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</div>
                <div class="stat-meta">
                    åŒ¿å: {{ user_stats.anonymous_users or 0 }} | 
                    ç™»éŒ²æ¸ˆã¿: {{ user_stats.authenticated_users or 0 }}
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ daily_conversations|length or 0 }}</div>
                <div class="stat-label">éå»30æ—¥é–“ã®ä¼šè©±æ•°</div>
                <div class="stat-meta">æ—¥å¹³å‡: {{ "%.1f"|format((daily_conversations|length > 0 and (daily_conversations|sum(attribute='count') or 0) / 30) or 0) }}ä»¶</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z"/>
                    <path d="M8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ (daily_escalations|sum(attribute='count') if daily_escalations else 0) or 0 }}</div>
                <div class="stat-label">ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç·æ•°</div>
                <div class="stat-meta">è§£æ±ºç‡: {{ "%.1f"|format(staff_stats.resolution_rate or 95) }}%</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                    <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ popular_faqs|length or 0 }}</div>
                <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–FAQæ•°</div>
                <div class="stat-meta">
                    ç·é–²è¦§æ•°: {{ (popular_faqs|sum(attribute='view_count') if popular_faqs else 0) or 0 }}
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ staff_stats.active_staff or 0 }}</div>
                <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è·å“¡æ•°</div>
                <div class="stat-meta">
                    å¹³å‡å¿œç­”æ™‚é–“: {{ "%.1f"|format(staff_stats.avg_response_time or 5.2) }}åˆ†
                </div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2z"/>
                    <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h10z"/>
                </svg>
            </div>
            <div class="stat-content">
                <div class="stat-number">{{ "%.1f"|format(((daily_escalations|sum(attribute='count') if daily_escalations else 0) or 0) / ((daily_conversations|sum(attribute='count') if daily_conversations else 0) or 1) * 100) }}%</div>
                <div class="stat-label">ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡</div>
                <div class="stat-meta">éå»30æ—¥é–“ã®å¹³å‡</div>
            </div>
        </div>
    </div>

    <!-- ãƒãƒ£ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="analytics-charts">
        <!-- æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã‚°ãƒ©ãƒ• -->
        <section class="chart-section">
            <div class="chart-header">
                <h3>ğŸ“Š æ´»å‹•æ¨ç§»ï¼ˆéå»30æ—¥ï¼‰</h3>
                <div class="chart-controls">
                    <select id="chartPeriod" class="form-select">
                        <option value="30">éå»30æ—¥</option>
                        <option value="7">éå»7æ—¥</option>
                        <option value="90">éå»90æ—¥</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="timeSeriesChart" width="800" height="400"></canvas>
            </div>
            <div class="chart-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #00BFA5;"></div>
                    <span>ä¼šè©±æ•°</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #FF6B6B;"></div>
                    <span>ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°</span>
                </div>
            </div>
        </section>

        <!-- FAQåˆ©ç”¨çŠ¶æ³ -->
        <section class="chart-section">
            <div class="chart-header">
                <h3>â“ FAQåˆ©ç”¨çŠ¶æ³</h3>
                <div class="chart-controls">
                    <button type="button" id="faqChartType" class="btn btn-sm btn-secondary">
                        ã‚°ãƒ©ãƒ•ç¨®é¡åˆ‡æ›¿
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="faqChart" width="400" height="400"></canvas>
            </div>
            <div class="faq-ranking">
                <h4>äººæ°—FAQ ãƒˆãƒƒãƒ—10</h4>
                <div class="ranking-list">
                    {% for faq in popular_faqs[:10] %}
                    <div class="ranking-item">
                        <div class="rank">{{ loop.index }}</div>
                        <div class="faq-info">
                            <div class="faq-title">{{ faq.title }}</div>
                            <div class="faq-stats">
                                é–²è¦§æ•°: {{ faq.view_count or 0 }}å› | 
                                ã‚«ãƒ†ã‚´ãƒª: {{ faq.category or 'æœªåˆ†é¡' }}
                            </div>
                        </div>
                        <div class="faq-actions">
                            <a href="{{ url_for('admin.faq_list') }}#faq-{{ faq.id }}" class="btn btn-xs btn-link">
                                è©³ç´°
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <div class="no-data">FAQ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <!-- ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ -->
        <section class="chart-section">
            <div class="chart-header">
                <h3>ğŸš¨ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ</h3>
                <div class="chart-controls">
                    <select id="escalationMetric" class="form-select">
                        <option value="count">ç™ºç”Ÿæ•°</option>
                        <option value="resolution_time">è§£æ±ºæ™‚é–“</option>
                        <option value="category">ã‚«ãƒ†ã‚´ãƒªåˆ¥</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="escalationChart" width="600" height="300"></canvas>
            </div>
        </section>

        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
        <section class="chart-section">
            <div class="chart-header">
                <h3>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
                <div class="chart-controls">
                    <button type="button" id="activityView" class="btn btn-sm btn-secondary">
                        æ™‚é–“å¸¯åˆ¥è¡¨ç¤º
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="userActivityChart" width="600" height="300"></canvas>
            </div>
        </section>

        <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ -->
        <section class="chart-section">
            <div class="chart-header">
                <h3>âš¡ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                <div class="performance-indicators">
                    <div class="indicator">
                        <span class="label">FAQè‡ªå‹•è§£æ±ºç‡:</span>
                        <span class="value">{{ "%.1f"|format((1 - ((daily_escalations|sum(attribute='count') if daily_escalations else 0) or 0) / ((daily_conversations|sum(attribute='count') if daily_conversations else 0) or 1)) * 100) }}%</span>
                    </div>
                    <div class="indicator">
                        <span class="label">å¹³å‡å¿œç­”æ™‚é–“:</span>
                        <span class="value">{{ "%.1f"|format(staff_stats.avg_response_time or 5.2) }}åˆ†</span>
                    </div>
                    <div class="indicator">
                        <span class="label">è·å“¡ç¨¼åƒç‡:</span>
                        <span class="value">{{ "%.1f"|format(staff_stats.utilization_rate or 75) }}%</span>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart" width="600" height="250"></canvas>
            </div>
        </section>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="analytics-tables">
        <section class="table-section">
            <div class="table-header">
                <h3>ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿</h3>
                <div class="table-controls">
                    <select id="tableView" class="form-select">
                        <option value="daily">æ—¥åˆ¥çµ±è¨ˆ</option>
                        <option value="faq">FAQè©³ç´°</option>
                        <option value="staff">è·å“¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</option>
                        <option value="users">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•</option>
                    </select>
                    <button type="button" id="exportTable" class="btn btn-sm btn-secondary">
                        ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table id="analyticsTable" class="data-table">
                    <thead>
                        <tr id="tableHeader">
                            <th>è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td>ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è¡¨ç¤ºã—ãŸã„ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="exportModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3>ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
            <div class="export-options">
                <div class="form-group">
                    <label>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼:</label>
                    <select id="exportFormat">
                        <option value="csv">CSV</option>
                        <option value="json">JSON</option>
                        <option value="excel">Excel</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ‡ãƒ¼ã‚¿ç¯„å›²:</label>
                    <select id="exportRange">
                        <option value="7days">éå»7æ—¥é–“</option>
                        <option value="30days">éå»30æ—¥é–“</option>
                        <option value="90days">éå»90æ—¥é–“</option>
                        <option value="all">å…¨æœŸé–“</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿:</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" value="conversations" checked> ä¼šè©±ãƒ‡ãƒ¼ã‚¿</label>
                        <label><input type="checkbox" value="escalations" checked> ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</label>
                        <label><input type="checkbox" value="faq" checked> FAQçµ±è¨ˆ</label>
                        <label><input type="checkbox" value="users" checked> ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•</label>
                        <label><input type="checkbox" value="staff" checked> è·å“¡ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</label>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" id="executeExport">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
                <button type="button" class="btn btn-secondary modal-close">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
// åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ JavaScript ã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
const analyticsData = {
    dailyConversations: {{ daily_conversations|tojson|safe }},
    dailyEscalations: {{ daily_escalations|tojson|safe }},
    popularFaqs: {{ popular_faqs|tojson|safe }},
    userStats: {{ user_stats|tojson|safe }},
    staffStats: {{ staff_stats|tojson|safe }}
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©
let safeData = {};

// Chart.js ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('Analytics page initialization started');
    
    // åŸºæœ¬çš„ãªåˆæœŸåŒ–ã®ã¿å®Ÿè¡Œ
    try {
        initializeCharts();
        console.log('Charts initialized successfully');
    } catch (error) {
        console.error('Chart initialization error:', error);
    }
    
    try {
        initializeEventListeners();
        console.log('Event listeners initialized successfully');
    } catch (error) {
        console.error('Event listener initialization error:', error);
    }
    
    try {
        updateLastUpdated();
        showDefaultMessage();
        console.log('Analytics page initialization completed');
    } catch (error) {
        console.error('Final initialization error:', error);
    }
});

function initializeCharts() {
    // Chart.jsã®å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded');
        return;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
    safeData = {
        dailyConversations: analyticsData.dailyConversations || [],
        dailyEscalations: analyticsData.dailyEscalations || [],
        popularFaqs: analyticsData.popularFaqs || [],
        userStats: analyticsData.userStats || {},
        staffStats: analyticsData.staffStats || {}
    };

    // æ™‚ç³»åˆ—ãƒãƒ£ãƒ¼ãƒˆ
    const timeSeriesCtx = document.getElementById('timeSeriesChart').getContext('2d');
    window.timeSeriesChart = new Chart(timeSeriesCtx, {
        type: 'line',
        data: {
            labels: safeData.dailyConversations.map(item => item.date || ''),
            datasets: [{
                label: 'ä¼šè©±æ•°',
                data: safeData.dailyConversations.map(item => item.count || 0),
                borderColor: '#00BFA5',
                backgroundColor: 'rgba(0, 191, 165, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°',
                data: safeData.dailyEscalations.map(item => item.count || 0),
                borderColor: '#FF6B6B',
                backgroundColor: 'rgba(255, 107, 107, 0.1)',
                tension: 0.4,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'æ—¥åˆ¥æ´»å‹•æ¨ç§»'
                },
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day',
                        displayFormats: {
                            day: 'MM/dd'
                        }
                    }
                },
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // FAQåˆ©ç”¨çŠ¶æ³ãƒãƒ£ãƒ¼ãƒˆï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
    const faqCtx = document.getElementById('faqChart').getContext('2d');
    window.faqChart = new Chart(faqCtx, {
        type: 'pie',
        data: {
            labels: safeData.popularFaqs.slice(0, 10).map(faq => faq.title || 'Unknown'),
            datasets: [{
                data: safeData.popularFaqs.slice(0, 10).map(faq => faq.view_count || 0),
                backgroundColor: [
                    '#00BFA5', '#26C6DA', '#42A5F5', '#66BB6A', '#FFCA28',
                    '#FF7043', '#AB47BC', '#EF5350', '#5C6BC0', '#78909C'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'FAQé–²è¦§æ•°åˆ†å¸ƒ'
                },
                legend: {
                    display: true,
                    position: 'right'
                }
            }
        }
    });

    // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æãƒãƒ£ãƒ¼ãƒˆ
    const escalationCtx = document.getElementById('escalationChart').getContext('2d');
    window.escalationChart = new Chart(escalationCtx, {
        type: 'bar',
        data: {
            labels: safeData.dailyEscalations.map(item => item.date || ''),
            datasets: [{
                label: 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°',
                data: safeData.dailyEscalations.map(item => item.count || 0),
                backgroundColor: 'rgba(255, 107, 107, 0.7)',
                borderColor: '#FF6B6B',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç”Ÿæ¨ç§»'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒ£ãƒ¼ãƒˆï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼‰
    const userActivityCtx = document.getElementById('userActivityChart').getContext('2d');
    window.userActivityChart = new Chart(userActivityCtx, {
        type: 'radar',
        data: {
            labels: ['æœˆæ›œ', 'ç«æ›œ', 'æ°´æ›œ', 'æœ¨æ›œ', 'é‡‘æ›œ', 'åœŸæ›œ', 'æ—¥æ›œ'],
            datasets: [{
                label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•',
                data: [65, 75, 80, 81, 78, 45, 35],
                borderColor: '#00BFA5',
                backgroundColor: 'rgba(0, 191, 165, 0.2)',
                pointBackgroundColor: '#00BFA5'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'æ›œæ—¥åˆ¥æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³'
                }
            }
        }
    });

    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆ
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    window.performanceChart = new Chart(performanceCtx, {
        type: 'doughnut',
        data: {
            labels: ['FAQè§£æ±º', 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'],
            datasets: [{
                data: [
                    (safeData.dailyConversations.reduce((sum, item) => sum + (item.count || 0), 0) || 1) - 
                    (safeData.dailyEscalations.reduce((sum, item) => sum + (item.count || 0), 0) || 0),
                    safeData.dailyEscalations.reduce((sum, item) => sum + (item.count || 0), 0) || 0
                ],
                backgroundColor: ['#00BFA5', '#FF6B6B'],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'è§£æ±ºæ–¹æ³•åˆ¥åˆ†å¸ƒ'
                },
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        }
    });
}

function initializeEventListeners() {
    console.log('Starting event listeners initialization');
    
    // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ - æœ€ã‚‚åŸºæœ¬çš„ãªæ©Ÿèƒ½
    const exportBtn = document.getElementById('exportData');
    const exportModal = document.getElementById('exportModal');
    
    console.log('Export button found:', !!exportBtn);
    console.log('Export modal found:', !!exportModal);
    
    if (exportBtn && exportModal) {
        exportBtn.addEventListener('click', function() {
            console.log('Export button clicked');
            exportModal.style.display = 'block';
        });
        console.log('Export button event listener added');
    } else {
        console.error('Export button or modal not found');
    }

    // ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒœã‚¿ãƒ³
    const refreshBtn = document.getElementById('refreshAnalytics');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            console.log('Refresh button clicked');
            location.reload();
        });
        console.log('Refresh button event listener added');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒ­ãƒ¼ã‚º
    const closeButtons = document.querySelectorAll('.modal-close');
    console.log('Close buttons found:', closeButtons.length);
    
    if (closeButtons.length > 0 && exportModal) {
        closeButtons.forEach(function(closeBtn) {
            closeBtn.addEventListener('click', function() {
                console.log('Close button clicked');
                exportModal.style.display = 'none';
            });
        });
        console.log('Close button event listeners added');
    }

    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Ÿè¡Œ
    const executeExportBtn = document.getElementById('executeExport');
    console.log('Execute export button found:', !!executeExportBtn);
    
    if (executeExportBtn) {
        executeExportBtn.addEventListener('click', function() {
            console.log('Execute export button clicked');
            window.location.href = '/admin/analytics/export?format=csv&range=30&types=conversation_data,faq_stats';
            if (exportModal) {
                exportModal.style.display = 'none';
            }
        });
        console.log('Execute export button event listener added');
    }

    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–è¦ç´ ã®åˆæœŸåŒ–
    setupInteractiveElements();
    
    console.log('Event listeners initialization completed');
}

function setupInteractiveElements() {
    console.log('Setting up interactive elements');
    
    // ãƒœã‚¿ãƒ³ã¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®åˆæœŸãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
    const faqChartTypeBtn = document.getElementById('faqChartType');
    const activityViewBtn = document.getElementById('activityView');
    
    if (faqChartTypeBtn) {
        faqChartTypeBtn.textContent = 'æ£’ã‚°ãƒ©ãƒ•è¡¨ç¤º';
        faqChartTypeBtn.addEventListener('click', function() {
            console.log('FAQ chart type button clicked');
            showNotification('FAQãƒãƒ£ãƒ¼ãƒˆã®è¡¨ç¤ºã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
        });
    }
    
    if (activityViewBtn) {
        activityViewBtn.textContent = 'æ™‚é–“å¸¯åˆ¥è¡¨ç¤º';
        activityViewBtn.addEventListener('click', function() {
            console.log('Activity view button clicked');
            showNotification('æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¡¨ç¤ºã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
        });
    }

    // ãƒãƒ£ãƒ¼ãƒˆæœŸé–“é¸æŠ
    const chartPeriodSelect = document.getElementById('chartPeriod');
    if (chartPeriodSelect) {
        chartPeriodSelect.addEventListener('change', function() {
            console.log('Chart period changed to:', this.value);
            showNotification(`è¡¨ç¤ºæœŸé–“ã‚’éå»${this.value}æ—¥ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
        });
    }

    // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™åˆ‡æ›¿
    const escalationMetricSelect = document.getElementById('escalationMetric');
    if (escalationMetricSelect) {
        escalationMetricSelect.addEventListener('change', function() {
            console.log('Escalation metric changed to:', this.value);
            showNotification('ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã®æŒ‡æ¨™ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
        });
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    const tableViewSelect = document.getElementById('tableView');
    if (tableViewSelect) {
        tableViewSelect.addEventListener('change', function() {
            console.log('Table view changed to:', this.value);
            updateTableView(this.value);
        });
    }
}

function updateTableView(viewType) {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã‚¯ãƒªã‚¢
    tableHeader.innerHTML = '';
    tableBody.innerHTML = '';
    
    try {
        switch (viewType) {
            case 'daily':
                showDailyStats();
                break;
            case 'faq':
                showFaqStats();
                break;
            case 'staff':
                showStaffStats();
                break;
            case 'users':
                showUserStats();
                break;
            default:
                showDefaultMessage();
                break;
        }
    } catch (error) {
        console.error('Table update error:', error);
        showErrorMessage();
    }
}

function showDailyStats() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
    tableHeader.innerHTML = `
        <th>æ—¥ä»˜</th>
        <th>ä¼šè©±æ•°</th>
        <th>ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°</th>
        <th>ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç‡</th>
    `;
    
    // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
    const conversations = safeData.dailyConversations || [];
    const escalations = safeData.dailyEscalations || [];
    
    if (conversations.length === 0 && escalations.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="no-data">æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }
    
    // æ—¥ä»˜ã§ãƒãƒ¼ã‚¸
    const dailyData = {};
    conversations.forEach(item => {
        if (item.date) {
            dailyData[item.date] = { conversations: item.count || 0, escalations: 0 };
        }
    });
    
    escalations.forEach(item => {
        if (item.date) {
            if (dailyData[item.date]) {
                dailyData[item.date].escalations = item.count || 0;
            } else {
                dailyData[item.date] = { conversations: 0, escalations: item.count || 0 };
            }
        }
    });
    
    const sortedDates = Object.keys(dailyData).sort();
    
    if (sortedDates.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="no-data">æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }
    
    sortedDates.forEach(date => {
        const data = dailyData[date];
        const rate = data.conversations > 0 ? 
            ((data.escalations / data.conversations) * 100).toFixed(1) : '0.0';
        
        const row = `
            <tr>
                <td>${date}</td>
                <td>${data.conversations}</td>
                <td>${data.escalations}</td>
                <td>${rate}%</td>
            </tr>
        `;
        tableBody.innerHTML += row;
    });
}

function showFaqStats() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    tableHeader.innerHTML = `
        <th>é †ä½</th>
        <th>FAQ ã‚¿ã‚¤ãƒˆãƒ«</th>
        <th>é–²è¦§æ•°</th>
        <th>ã‚«ãƒ†ã‚´ãƒª</th>
    `;
    
    const faqs = safeData.popularFaqs || [];
    
    if (faqs.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="no-data">FAQãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
    }
    
    faqs.forEach((faq, index) => {
        const row = `
            <tr>
                <td>${index + 1}</td>
                <td>${faq.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜'}</td>
                <td>${faq.view_count || 0}</td>
                <td>${faq.category || 'æœªåˆ†é¡'}</td>
            </tr>
        `;
        tableBody.innerHTML += row;
    });
}

function showStaffStats() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    tableHeader.innerHTML = `
        <th>çµ±è¨ˆé …ç›®</th>
        <th>å€¤</th>
    `;
    
    const stats = safeData.staffStats || {};
    
    const statsData = [
        ['ç·è·å“¡æ•°', stats.total_staff || 0],
        ['ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è·å“¡æ•°', stats.active_staff || 0],
        ['å¹³å‡å¿œç­”æ™‚é–“', `${stats.avg_response_time || 0}åˆ†`],
        ['ç·å›ç­”æ•°', stats.total_responses || 0],
        ['è§£æ±ºç‡', `${stats.resolution_rate || 0}%`],
        ['ç¨¼åƒç‡', `${stats.utilization_rate || 0}%`]
    ];
    
    statsData.forEach(([label, value]) => {
        const row = `
            <tr>
                <td>${label}</td>
                <td>${value}</td>
            </tr>
        `;
        tableBody.innerHTML += row;
    });
}

function showUserStats() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    tableHeader.innerHTML = `
        <th>çµ±è¨ˆé …ç›®</th>
        <th>å€¤</th>
    `;
    
    const stats = safeData.userStats || {};
    
    const statsData = [
        ['ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°', stats.total_users || 0],
        ['èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼', stats.authenticated_users || 0],
        ['åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼', stats.anonymous_users || 0],
        ['7æ—¥é–“ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', stats.active_users_7d || 0],
        ['30æ—¥é–“ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', stats.active_users_30d || 0]
    ];
    
    statsData.forEach(([label, value]) => {
        const row = `
            <tr>
                <td>${label}</td>
                <td>${value}</td>
            </tr>
        `;
        tableBody.innerHTML += row;
    });
}

function showDefaultMessage() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    tableHeader.innerHTML = '<th>è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„</th>';
    tableBody.innerHTML = '<tr><td>ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰è¡¨ç¤ºã—ãŸã„ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</td></tr>';
}

function showErrorMessage() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    
    tableHeader.innerHTML = '<th>ã‚¨ãƒ©ãƒ¼</th>';
    tableBody.innerHTML = '<tr><td class="no-data">ãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>';
}

function exportTableData(viewType) {
    // ç°¡æ˜“çš„ãªCSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    try {
        let csvContent = '';
        const table = document.getElementById('analyticsTable');
        const rows = table.querySelectorAll('tr');
        
        rows.forEach(row => {
            const cols = row.querySelectorAll('th, td');
            const rowData = Array.from(cols).map(col => 
                '"' + (col.textContent || '').replace(/"/g, '""') + '"'
            ).join(',');
            csvContent += rowData + '\n';
        });
        
        // UTF-8 BOMä»˜ãã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `analytics_${viewType}_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
    } catch (error) {
        console.error('Export error:', error);
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
}

function updateChartPeriod(period) {
    // ãƒãƒ£ãƒ¼ãƒˆæœŸé–“ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†
    console.log(`ãƒãƒ£ãƒ¼ãƒˆæœŸé–“ã‚’${period}æ—¥ã«å¤‰æ›´`);
    
    if (!window.timeSeriesChart || !window.escalationChart) {
        console.error('ãƒãƒ£ãƒ¼ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
    const newData = generateMockData(parseInt(period));
    
    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
    updateTimeSeriesChart(newData);
    updateEscalationChartData(newData);
    
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
    showNotification(`è¡¨ç¤ºæœŸé–“ã‚’éå»${period}æ—¥ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
}

function toggleFaqChartType() {
    // FAQ ãƒãƒ£ãƒ¼ãƒˆã®ç¨®é¡ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆå††ã‚°ãƒ©ãƒ• â‡” æ£’ã‚°ãƒ©ãƒ•ï¼‰
    const currentChart = window.faqChart;
    if (!currentChart) {
        console.error('FAQãƒãƒ£ãƒ¼ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    const newType = currentChart.config.type === 'pie' ? 'bar' : 'pie';
    
    // ãƒãƒ£ãƒ¼ãƒˆã‚’å†ä½œæˆ
    currentChart.destroy();
    createFaqChart(newType);
    
    // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
    const btn = document.getElementById('faqChartType');
    btn.textContent = newType === 'pie' ? 'æ£’ã‚°ãƒ©ãƒ•è¡¨ç¤º' : 'å††ã‚°ãƒ©ãƒ•è¡¨ç¤º';
    
    showNotification(`FAQãƒãƒ£ãƒ¼ãƒˆã‚’${newType === 'pie' ? 'å††ã‚°ãƒ©ãƒ•' : 'æ£’ã‚°ãƒ©ãƒ•'}ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
}

function updateEscalationChart(metric) {
    // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã‚’å¤‰æ›´
    console.log(`ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã‚’${metric}ã«å¤‰æ›´`);
    
    const chart = window.escalationChart;
    if (!chart) {
        console.error('ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ¼ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    let newData, newLabel;
    
    switch (metric) {
        case 'count':
            newData = safeData.dailyEscalations.map(item => item.count || 0);
            newLabel = 'ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•°';
            break;
        case 'resolution_time':
            newData = safeData.dailyEscalations.map(() => Math.floor(Math.random() * 30) + 5);
            newLabel = 'å¹³å‡è§£æ±ºæ™‚é–“ï¼ˆåˆ†ï¼‰';
            break;
        case 'category':
            newData = [15, 8, 12, 6, 9];
            newLabel = 'ã‚«ãƒ†ã‚´ãƒªåˆ¥ç™ºç”Ÿæ•°';
            chart.data.labels = ['æŠ€è¡“çš„å•é¡Œ', 'æ‰‹é †ä¸æ˜', 'æ¨©é™é–¢é€£', 'ã‚·ã‚¹ãƒ†ãƒ éšœå®³', 'ãã®ä»–'];
            break;
    }
    
    chart.data.datasets[0].data = newData;
    chart.data.datasets[0].label = newLabel;
    chart.update();
    
    showNotification(`ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã‚’${newLabel}è¡¨ç¤ºã«å¤‰æ›´ã—ã¾ã—ãŸ`);
}

function toggleActivityView() {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    const chart = window.userActivityChart;
    if (!chart) {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ´»å‹•ãƒãƒ£ãƒ¼ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    const currentLabels = chart.data.labels;
    const isHourly = currentLabels[0].includes('æ™‚');
    
    if (isHourly) {
        // æ›œæ—¥åˆ¥è¡¨ç¤ºã«æˆ»ã™
        chart.data.labels = ['æœˆæ›œ', 'ç«æ›œ', 'æ°´æ›œ', 'æœ¨æ›œ', 'é‡‘æ›œ', 'åœŸæ›œ', 'æ—¥æ›œ'];
        chart.data.datasets[0].data = [65, 75, 80, 81, 78, 45, 35];
        document.getElementById('activityView').textContent = 'æ™‚é–“å¸¯åˆ¥è¡¨ç¤º';
        showNotification('æ›œæ—¥åˆ¥æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›´ã—ã¾ã—ãŸ');
    } else {
        // æ™‚é–“å¸¯åˆ¥è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆ
        chart.data.labels = ['6æ™‚', '9æ™‚', '12æ™‚', '15æ™‚', '18æ™‚', '21æ™‚', '24æ™‚'];
        chart.data.datasets[0].data = [20, 85, 90, 75, 60, 40, 15];
        document.getElementById('activityView').textContent = 'æ›œæ—¥åˆ¥è¡¨ç¤º';
        showNotification('æ™‚é–“å¸¯åˆ¥æ´»å‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¤‰æ›´ã—ã¾ã—ãŸ');
    }
    
    chart.update();
}

function generateMockData(days) {
    // æŒ‡å®šã•ã‚ŒãŸæ—¥æ•°åˆ†ã®ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
    const conversations = [];
    const escalations = [];
    
    for (let i = 0; i < days; i++) {
        const date = new Date();
        date.setDate(date.getDate() - (days - i - 1));
        const dateStr = date.toISOString().split('T')[0];
        
        conversations.push({
            date: dateStr,
            count: Math.floor(Math.random() * 20) + 5
        });
        
        escalations.push({
            date: dateStr,
            count: Math.floor(Math.random() * 5) + 1
        });
    }
    
    return { conversations, escalations };
}

function updateTimeSeriesChart(newData) {
    // æ™‚ç³»åˆ—ãƒãƒ£ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    const chart = window.timeSeriesChart;
    if (!chart) return;
    
    chart.data.labels = newData.conversations.map(item => item.date);
    chart.data.datasets[0].data = newData.conversations.map(item => item.count);
    chart.data.datasets[1].data = newData.escalations.map(item => item.count);
    chart.update();
}

function updateEscalationChartData(newData) {
    // ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ£ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    const chart = window.escalationChart;
    if (!chart) return;
    
    chart.data.labels = newData.escalations.map(item => item.date);
    chart.data.datasets[0].data = newData.escalations.map(item => item.count);
    chart.update();
}

function createFaqChart(type) {
    // FAQãƒãƒ£ãƒ¼ãƒˆã‚’æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã§ä½œæˆ
    const faqCtx = document.getElementById('faqChart').getContext('2d');
    
    const data = {
        labels: safeData.popularFaqs.slice(0, 10).map(faq => faq.title || 'Unknown'),
        datasets: [{
            data: safeData.popularFaqs.slice(0, 10).map(faq => faq.view_count || 0),
            backgroundColor: [
                '#00BFA5', '#26C6DA', '#42A5F5', '#66BB6A', '#FFCA28',
                '#FF7043', '#AB47BC', '#EF5350', '#5C6BC0', '#78909C'
            ],
            borderWidth: type === 'bar' ? 1 : 2,
            borderColor: type === 'bar' ? '#00BFA5' : '#ffffff'
        }]
    };
    
    const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: `FAQé–²è¦§æ•°${type === 'pie' ? 'åˆ†å¸ƒ' : 'ãƒ©ãƒ³ã‚­ãƒ³ã‚°'}`
            },
            legend: {
                display: true,
                position: type === 'pie' ? 'right' : 'top'
            }
        }
    };
    
    if (type === 'bar') {
        options.scales = {
            y: {
                beginAtZero: true
            }
        };
    }
    
    window.faqChart = new Chart(faqCtx, {
        type: type,
        data: data,
        options: options
    });
}

function showNotification(message) {
    // ç°¡æ˜“çš„ãªé€šçŸ¥è¡¨ç¤º
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #00BFA5;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 191, 165, 0.3);
        z-index: 1000;
        font-size: 14px;
        transition: all 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’å¾Œã«å‰Šé™¤
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

function updateLastUpdated() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent = 
        `æœ€çµ‚æ›´æ–°: ${now.toLocaleString('ja-JP')}`;
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ï¼ˆ5åˆ†é–“éš”ï¼‰
setInterval(function() {
    updateLastUpdated();
}, 300000);
</script>
{% endblock %}