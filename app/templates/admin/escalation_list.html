{% extends "admin/base.html" %}

{% block content %}
<div class="escalation-management">
    <div class="page-header">
        <h2>ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†</h2>
        <div class="escalation-stats">
            <span class="pending-count">{{ escalations|length }} ä»¶ã®æœªè§£æ±ºè³ªå•</span>
        </div>
    </div>
    
    {% if escalations %}
        <div class="escalation-list">
            {% for escalation in escalations %}
            <div class="escalation-card" data-escalation-id="{{ escalation.id }}">
                <div class="escalation-header">
                    <div class="escalation-meta">
                        <span class="escalation-date">{{ escalation.created_at.strftime('%Y/%m/%d %H:%M') }}</span>
                        <span class="status-badge pending">æœªè§£æ±º</span>
                    </div>
                    <div class="escalation-user">
                        {% if escalation.message.conversation.user %}
                            <div class="user-info">
                                <span class="user-icon">
                                    {% if escalation.message.conversation.user.user_type == 'staff' %}
                                        ğŸ‘¨â€ğŸ’¼
                                    {% elif escalation.message.conversation.user.is_anonymous %}
                                        ğŸ‘¤
                                    {% else %}
                                        ğŸ‘¥
                                    {% endif %}
                                </span>
                                <span class="user-name">
                                    {{ escalation.message.conversation.user.display_name or escalation.message.conversation.user.identifier }}
                                </span>
                                {% if escalation.message.conversation.user.department %}
                                <span class="user-department">({{ escalation.message.conversation.user.department }})</span>
                                {% endif %}
                            </div>
                        {% elif escalation.message.conversation.user_display_name %}
                            <div class="user-info">
                                <span class="user-icon">ğŸ‘¤</span>
                                <span class="user-name">{{ escalation.message.conversation.user_display_name }}</span>
                                <span class="user-type">(åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼)</span>
                            </div>
                        {% else %}
                            <div class="user-info">
                                <span class="user-icon">â“</span>
                                <span class="user-name">ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                                <span class="user-type">(åŒ¿å)</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="escalation-content">
                    <div class="original-question">
                        <h4>è³ªå•å†…å®¹</h4>
                        <p>{{ escalation.message.content }}</p>
                        {% if escalation.message.file_name %}
                        <div class="attachment">
                            ğŸ“ æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«: {{ escalation.message.file_name }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="response-section">
                        <h4>è·å“¡å›ç­”</h4>
                        <form class="response-form" data-escalation-id="{{ escalation.id }}">
                            <textarea 
                                name="staff_response" 
                                placeholder="åˆ©ç”¨è€…ã¸ã®å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                                rows="4"
                                required>{{ escalation.staff_response or '' }}</textarea>
                            
                            <div class="response-meta">
                                <input 
                                    type="text" 
                                    name="staff_name" 
                                    placeholder="å¯¾å¿œè€…åï¼ˆä»»æ„ï¼‰"
                                    value="{{ escalation.staff_name or '' }}">
                            </div>
                            
                            <div class="response-actions">
                                <button type="submit" class="btn btn-primary">
                                    å›ç­”ã‚’é€ä¿¡
                                </button>
                                <button type="button" class="btn btn-secondary close-escalation-btn" data-escalation-id="{{ escalation.id }}">
                                    ã‚¯ãƒ­ãƒ¼ã‚º
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="no-escalations">
            <div class="no-data-message">
                <h3>ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼</h3>
                <p>ç¾åœ¨ã€æœªè§£æ±ºã®è³ªå•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                <p>æ–°ã—ã„è³ªå•ãŒæ¥ãŸã¨ãã«ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    
    // å›ç­”ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.querySelectorAll('.response-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const escalationId = this.dataset.escalationId;
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`/admin/escalation/${escalationId}/respond`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('å›ç­”ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        });
    });
    
    // ã‚¯ãƒ­ãƒ¼ã‚ºãƒœã‚¿ãƒ³
    document.querySelectorAll('.close-escalation-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            if (!confirm('ã“ã®è³ªå•ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const escalationId = this.dataset.escalationId;
            
            try {
                const response = await fetch(`/admin/escalation/${escalationId}/close`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage('è³ªå•ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('ã‚¯ãƒ­ãƒ¼ã‚ºã‚¨ãƒ©ãƒ¼:', error);
                showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        });
    });
    
    function showMessage(message, type) {
        const existingMessages = document.querySelectorAll('.temp-flash-message');
        existingMessages.forEach(msg => msg.remove());
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `flash-message flash-${type} temp-flash-message`;
        messageDiv.textContent = message;
        
        const adminMain = document.querySelector('.admin-main');
        adminMain.insertBefore(messageDiv, adminMain.firstChild);
        
        setTimeout(() => messageDiv.remove(), 5000);
    }
});
</script>
{% endblock %}