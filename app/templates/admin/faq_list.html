{% extends "admin/base.html" %}

{% block content %}
<div class="faq-management">
    <div class="page-header">
        <h2>FAQç®¡ç†</h2>
        <div class="header-buttons">
            <button id="addFaqBtn" class="btn btn-primary">
                â• FAQè¿½åŠ 
            </button>
            <a href="{{ url_for('admin.bulk_import_faq') }}" class="btn btn-secondary">
                ğŸ“¥ ä¸€æ‹¬å–ã‚Šè¾¼ã¿
            </a>
            <div class="dropdown">
                <button class="btn btn-outline dropdown-toggle" type="button" onclick="toggleDropdown()">
                    ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
                <div id="exportDropdown" class="dropdown-menu">
                    <a class="dropdown-item" href="{{ url_for('admin.export_faq', format='csv') }}">
                        ğŸ“Š CSVå½¢å¼
                    </a>
                    <a class="dropdown-item" href="{{ url_for('admin.export_faq', format='json') }}">
                        ğŸ“„ JSONå½¢å¼
                    </a>
                    <a class="dropdown-item" href="{{ url_for('admin.export_faq', format='excel') }}">
                        ğŸ“ˆ Excelå½¢å¼
                    </a>
                </div>
            </div>
        </div>
    </div>
    

    <div class="faq-stats">
        <div class="stat-item">
            <span class="count">{{ faqs|length }}</span>
            <span class="label">ç·FAQæ•°</span>
        </div>
        <div class="stat-item">
            <span class="count">{{ faqs|selectattr('is_active')|list|length }}</span>
            <span class="label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>
        </div>
        <div class="stat-item">
            <span class="count">{{ faqs|rejectattr('is_active')|list|length }}</span>
            <span class="label">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>
        </div>
    </div>
    
    <div class="faq-table-container">
        <table class="faq-table">
            <thead>
                <tr>
                    <th>çŠ¶æ…‹</th>
                    <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                    <th>ã‚«ãƒ†ã‚´ãƒª</th>
                    <th>å‚ç…§å›æ•°</th>
                    <th>ä½œæˆæ—¥</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for faq in faqs %}
                <tr class="{% if not faq.is_active %}inactive{% endif %}">
                    <td>
                        <span class="status-badge {% if faq.is_active %}active{% else %}inactive{% endif %}">
                            {% if faq.is_active %}ã‚¢ã‚¯ãƒ†ã‚£ãƒ–{% else %}éã‚¢ã‚¯ãƒ†ã‚£ãƒ–{% endif %}
                        </span>
                    </td>
                    <td>
                        <div class="faq-title">{{ faq.title }}</div>
                        <div class="faq-preview">{{ faq.question[:100] }}...</div>
                    </td>
                    <td>{{ faq.category or 'æœªåˆ†é¡' }}</td>
                    <td>{{ faq.view_count }}</td>
                    <td>{{ faq.created_at.strftime('%Y/%m/%d') if faq.created_at else '-' }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon edit-btn" data-faq-id="{{ faq.id }}" title="ç·¨é›†">
                                âœï¸
                            </button>
                            <button class="btn-icon toggle-btn" data-faq-id="{{ faq.id }}" data-active="{{ faq.is_active|lower }}" title="{% if faq.is_active %}éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–{% else %}ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–{% endif %}">
                                {% if faq.is_active %}ğŸ‘ï¸{% else %}ğŸš«{% endif %}
                            </button>
                            <button class="btn-icon delete-btn" data-faq-id="{{ faq.id }}" title="å‰Šé™¤">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="no-data">FAQãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„FAQã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- FAQç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="faqModal" class="modal">
    <div class="modal-content large">
        <span class="modal-close">&times;</span>
        <h3 id="modalTitle">FAQè¿½åŠ </h3>
        
        <form id="faqForm" class="faq-form">
            <input type="hidden" id="faqId" name="faq_id">
            
            <div class="form-group">
                <label for="faqTitle">ã‚¿ã‚¤ãƒˆãƒ« <span class="required">*</span></label>
                <input type="text" id="faqTitle" name="title" required maxlength="200">
            </div>
            
            <div class="form-group">
                <label for="faqCategory">ã‚«ãƒ†ã‚´ãƒª</label>
                <select id="faqCategory" name="category">
                    <option value="">æœªåˆ†é¡</option>
                    <option value="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</option>
                    <option value="ã‚¨ãƒ©ãƒ¼å¯¾å¿œ">ã‚¨ãƒ©ãƒ¼å¯¾å¿œ</option>
                    <option value="é€ä¿¡ãƒ«ãƒ¼ãƒ«">é€ä¿¡ãƒ«ãƒ¼ãƒ«</option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="faqQuestion">è³ªå•å†…å®¹ <span class="required">*</span></label>
                <textarea id="faqQuestion" name="question" rows="4" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="faqAnswer">å›ç­”å†…å®¹ <span class="required">*</span></label>
                <textarea id="faqAnswer" name="answer" rows="6" required></textarea>
            </div>
            
            <div class="form-group">
                <label for="faqKeywords">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                <input type="text" id="faqKeywords" name="keywords" placeholder="ä¾‹: DM,é€ä¿¡,ã‚¨ãƒ©ãƒ¼">
                <small>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¤œç´¢ã—ã‚„ã™ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="faqActive" name="is_active" checked>
                    ã“ã®FAQã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                </label>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.header-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
}

.dropdown {
    position: relative;
}

.dropdown-toggle {
    background: white;
    border: 1px solid #dee2e6;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

.dropdown-toggle:after {
    content: 'â–¼';
    font-size: 0.8em;
    margin-left: 5px;
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    min-width: 150px;
    z-index: 1000;
    display: none;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    display: block;
    padding: 8px 16px;
    text-decoration: none;
    color: #212529;
    white-space: nowrap;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
    text-decoration: none;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .header-buttons {
        justify-content: center;
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// FAQ ãƒ‡ãƒ¼ã‚¿ã‚’ JavaScript ã§ä½¿ç”¨ (JSON serialization error ã‚’å›é¿)
window.faqData = [
    {% for faq in faqs %}
    {
        id: {{ faq.id }},
        title: {{ faq.title|tojson }},
        question: {{ faq.question|tojson }},
        answer: {{ faq.answer|tojson }},
        keywords: {{ faq.keywords|tojson }},
        category: {{ faq.category|tojson }},
        is_active: {{ faq.is_active|tojson }},
        view_count: {{ faq.view_count }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆ¶å¾¡
function toggleDropdown() {
    const dropdown = document.getElementById('exportDropdown');
    dropdown.classList.toggle('show');
}

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('exportDropdown');
    const toggle = document.querySelector('.dropdown-toggle');
    
    if (!toggle.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});
</script>
{% endblock %}