{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <!-- FAQä¸€è¦§ï¼ˆå·¦å´ï¼‰ -->
    <div class="faq-sidebar" id="faqSidebar">
        <div class="faq-header">
            <h2>
                ã‚ˆãã‚ã‚‹è³ªå•
                <button type="button" class="faq-close-btn mobile-only" id="faqCloseBtn">Ã—</button>
            </h2>
            
            <!-- FAQæ¤œç´¢ãƒãƒ¼ -->
            <div class="faq-search-container">
                <input type="text" id="faqSearchInput" placeholder="FAQã‚’æ¤œç´¢..." class="faq-search-input">
                <button type="button" id="faqSearchClear" class="faq-search-clear" title="æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢">âœ•</button>
            </div>
            
            <!-- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div class="faq-filter-container">
                <select id="faqCategoryFilter" class="faq-category-filter">
                    <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                    {% if faqs %}
                        {% for category in faqs|map(attribute='category')|unique|list %}
                            {% if category %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            
            <!-- æ¤œç´¢çµæœè¡¨ç¤º -->
            <div class="faq-search-results" style="display: none;">
                <small id="faqSearchResultCount">0ä»¶ã®æ¤œç´¢çµæœ</small>
            </div>
        </div>

        <!-- äººæ°—FAQã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="popular-faq-section" id="popularFaqSection">
            <h3 class="popular-faq-title">ğŸ”¥ äººæ°—ã®FAQ</h3>
            <div class="popular-faq-list" id="popularFaqList">
                <!-- äººæ°—FAQãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
        </div>
        
        <div class="faq-list" id="faqList">
            {% if faqs and faqs|length > 0 %}
                {% for faq in faqs %}
                <div class="faq-item" 
                     data-faq-id="{{ faq.id }}"
                     data-category="{{ faq.category or '' }}"
                     data-keywords="{{ faq.keywords or '' }}"
                     data-search-text="{{ (faq.title + ' ' + faq.question + ' ' + faq.answer + ' ' + (faq.keywords or ''))|lower }}">
                    <div class="faq-item-header">
                        <div class="faq-title">{{ faq.title }}</div>
                        {% if faq.category %}
                        <div class="faq-category-badge">{{ faq.category }}</div>
                        {% endif %}
                    </div>
                    <div class="faq-preview">{{ faq.question[:80] }}...</div>
                    {% if faq.view_count > 0 %}
                    <div class="faq-stats">
                        <small>é–²è¦§æ•°: {{ faq.view_count }}</small>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="no-faq-message" style="padding: 20px; text-align: center; color: #666;">
                    FAQãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>
                    ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
                </div>
            {% endif %}
            
            <!-- æ¤œç´¢çµæœãŒãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="no-search-results" style="display: none; padding: 20px; text-align: center; color: #666;">
                <div>æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>
                <small>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</small>
            </div>
        </div>
    </div>
    
    <!-- FAQã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰ -->
    <div class="faq-sidebar-overlay" id="faqSidebarOverlay"></div>
    
    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ï¼ˆå³å´ï¼‰ -->
    <div class="chat-area chat-main">
        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="chat-header mobile-only">
            <h1 class="chat-title">DMä½œæ¥­ã‚µãƒãƒ¼ãƒˆ</h1>
            <div class="chat-controls">
                <button type="button" class="faq-toggle-btn" id="faqToggleBtn">FAQ</button>
            </div>
        </div>
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ãƒ‘ãƒãƒ« -->
        <div class="user-identity-panel" id="userIdentityPanel">
            <div class="identity-header">
                <h4>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆä»»æ„ï¼‰</h4>
                <p>ã‚ˆã‚Šè‰¯ã„ã‚µãƒãƒ¼ãƒˆã®ãŸã‚ã€ãŠåå‰ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚</p>
            </div>
            <div class="identity-form">
                <div class="input-group">
                    <input type="text" id="userNameInput" placeholder="ãŠåå‰ï¼ˆä¾‹ï¼šç”°ä¸­å¤ªéƒï¼‰" maxlength="50">
                    <input type="text" id="userDepartmentInput" placeholder="æ‰€å±éƒ¨ç½²ï¼ˆä»»æ„ï¼‰" maxlength="50">
                </div>
                <div class="identity-actions">
                    <button type="button" id="identifyUserBtn" class="btn btn-primary">ç¢ºèª</button>
                    <button type="button" class="btn btn-link" onclick="document.getElementById('userIdentityPanel').style.display='none'">ã‚¹ã‚­ãƒƒãƒ—</button>
                </div>
            </div>
        </div>
        
        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="user-display-area">
            <div class="user-info">
                <span class="user-icon">ğŸ‘¤</span>
                <span id="userDisplayName">åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                <span id="userStatus" class="user-status anonymous">æœªè­˜åˆ¥</span>
                <button type="button" id="clearIdentityBtn" class="btn-clear-identity" title="è­˜åˆ¥æƒ…å ±ã‚’ã‚¯ãƒªã‚¢">âœ•</button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message bot-message">
                <div class="message-bubble">
                    <div class="message-content">
                        ã“ã‚“ã«ã¡ã¯ï¼DMé€ä¿¡ä½œæ¥­ã«ã¤ã„ã¦ãŠå›°ã‚Šã®ã“ã¨ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ã”è³ªå•ãã ã•ã„ã€‚<br>
                        å·¦å´ã®ã‚ˆãã‚ã‚‹è³ªå•ã‚‚ã”å‚è€ƒãã ã•ã„ã€‚
                    </div>
                    <div class="message-time"></div>
                </div>
            </div>
        </div>

        <!-- ã‚ˆãã‚ã‚‹è³ªå•ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ -->
        <div class="quick-faq-access" id="quickFaqAccess">
            <div class="quick-faq-title">ğŸ’¡ ã‚ˆãã‚ã‚‹è³ªå•</div>
            <div class="quick-faq-buttons" id="quickFaqButtons">
                <button type="button" class="quick-faq-btn" data-search="é€ä¿¡æ¨©é™">
                    ğŸ” é€ä¿¡æ¨©é™ã«ã¤ã„ã¦
                </button>
                <button type="button" class="quick-faq-btn" data-search="ã‚¨ãƒ©ãƒ¼">
                    âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰
                </button>
                <button type="button" class="quick-faq-btn" data-search="ãƒ­ã‚°ã‚¤ãƒ³">
                    ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„
                </button>
                <button type="button" class="quick-faq-btn" data-search="ãƒ•ã‚¡ã‚¤ãƒ«">
                    ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦
                </button>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="input-group">
                <textarea 
                    id="messageInput" 
                    placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." 
                    rows="3"
                    maxlength="1000"></textarea>
                <div class="input-actions">
                    <button type="button" id="fileButton" class="file-button" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜">
                        ğŸ“
                    </button>
                    <button type="button" id="sendButton" class="send-button" style="display: flex; align-items: center; justify-content: center;">
                        <img src="{{ url_for('static', filename='icon06.png') }}" alt="é€ä¿¡" class="send-icon-enabled icon-large" loading="lazy">
                        <img src="{{ url_for('static', filename='icon07.png') }}" alt="é€ä¿¡ä¸å¯" class="send-icon-disabled icon-large" style="display: none;" loading="lazy">
                    </button>
                </div>
            </div>
            <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.txt">
            <div class="character-count">
                <span id="charCount">0</span>/1000æ–‡å­—
            </div>
        </div>
    </div>
</div>

<!-- FAQè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="faqModal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h3 id="faqModalTitle"></h3>
        <div class="faq-modal-body">
            <div class="faq-question">
                <strong>è³ªå•ï¼š</strong>
                <p id="faqModalQuestion"></p>
            </div>
            <div class="faq-answer">
                <strong>å›ç­”ï¼š</strong>
                <p id="faqModalAnswer"></p>
            </div>
        </div>
        <div class="modal-actions">
            <button id="useFaqButton" class="use-faq-button">ã“ã®å›ç­”ã‚’ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/user-identification.js') }}"></script>
<script src="{{ url_for('static', filename='js/faq-search.js') }}"></script>
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
// FAQãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§ä½¿ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
window.faqData = [
    {% for faq in faqs %}
    {
        id: {{ faq.id }},
        title: {{ faq.title|tojson }},
        question: {{ faq.question|tojson }},
        answer: {{ faq.answer|tojson }},
        keywords: {{ faq.keywords|tojson }},
        category: {{ faq.category|tojson }},
        is_active: {{ faq.is_active|tojson }},
        view_count: {{ faq.view_count }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
window.showFaqModal = function(faqId) {
    const faq = window.faqData?.find(f => f.id == faqId);
    if (!faq) {
        console.error('FAQ not found:', faqId);
        return;
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’æ›´æ–°
    document.getElementById('faqModalTitle').textContent = faq.title;
    document.getElementById('faqModalQuestion').textContent = faq.question;
    document.getElementById('faqModalAnswer').innerHTML = faq.answer.replace(/\n/g, '<br>');
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = document.getElementById('faqModal');
    modal.style.display = 'block';
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«ç§»å‹•
    const closeButton = modal.querySelector('.modal-close');
    if (closeButton) {
        closeButton.focus();
    }
    
    // FAQé–²è¦§æ•°ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
    updateFaqViewCount(faqId);
};

window.closeFaqModal = function() {
    const modal = document.getElementById('faqModal');
    if (modal) {
        modal.style.display = 'none';
    }
};

function updateFaqViewCount(faqId) {
    // FAQé–²è¦§æ•°ã‚’æ›´æ–°ï¼ˆéåŒæœŸå‡¦ç†ï¼‰
    fetch(`/api/faq/${faqId}/view`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content')
        }
    }).catch(error => {
        console.log('FAQé–²è¦§æ•°ã®æ›´æ–°ã«å¤±æ•—:', error);
        // ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã—ãªã„ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã®ãŸã‚ï¼‰
    });
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    // FAQè¦ç´ ã«ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    const faqItems = document.querySelectorAll('.faq-item');
    faqItems.forEach(item => {
        // æ—¢å­˜ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã«å¤‰æ›´
        item.addEventListener('dblclick', function(e) {
            e.preventDefault();
            const faqId = this.dataset.faqId;
            window.showFaqModal(faqId);
        });
        
        // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®CSSã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        item.style.cursor = 'pointer';
        item.title = 'ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º';
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    const modal = document.getElementById('faqModal');
    if (modal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                window.closeFaqModal();
            }
        });
        
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        const closeButton = modal.querySelector('.modal-close');
        if (closeButton) {
            closeButton.addEventListener('click', function() {
                window.closeFaqModal();
            });
        }
    }
    
    // Escã‚­ãƒ¼ã§é–‰ã˜ã‚‹
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('faqModal');
            if (modal && modal.style.display === 'block') {
                window.closeFaqModal();
            }
        }
    });
});
</script>
{% endblock %}